{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}


{% block body_class %}meal-generator-page{% endblock %}
{% block title %}NaijaPlate - Meal Generator{% endblock %}

{% block extra_head %}
<style>
    /* Existing styles */
    .recipe-content {
        max-height: calc(90vh - 200px);
        overflow-y: auto;
    }

    .recipe-tab {
        white-space: nowrap;
    }

    /* New styles */
    /* Hide scrollbar for main modal */
    .modal-container {
        overflow: hidden !important;
    }

    /* Custom scrollbar styles */
    .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #CBD5E0 transparent;
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #CBD5E0;
        border-radius: 3px;
    }

    /* Tab content container */
    .tab-content-container {
        height: calc(90vh - 160px);
        overflow: hidden;
    }

    /* Individual tab content */
    .recipe-content {
        height: 100%;
        overflow-y: auto;
        padding-right: 12px; /* Compensate for scrollbar */
    }

    /* Tabs scrollbar */
    .tabs-container {
        overflow-x: auto;
        scrollbar-width: thin;
        scrollbar-color: #CBD5E0 transparent;
    }

    .tabs-container::-webkit-scrollbar {
        height: 4px;
    }

    .tabs-container::-webkit-scrollbar-track {
        background: transparent;
    }

    .tabs-container::-webkit-scrollbar-thumb {
        background-color: #CBD5E0;
        border-radius: 2px;
    }
/* Multi-select styling */
select[multiple] {
    background-image: none !important;
    padding-right: 0.75rem !important;
}

select[multiple] option {
    padding: 0.5rem;
    margin: 0.25rem 0;
    border-radius: 0.375rem;
    transition: all 0.2s;
}

select[multiple] option:checked {
    background-color: #E8F5E9 !important;
    color: #059669 !important;
}

select[multiple]:disabled {
    background-color: #F3F4F6;
    cursor: not-allowed;
}

/* Skill level responsive styling */
.skill-level-option input:checked + div {
    border-color: #10B981;
    background-color: #ECFDF5;
}

@media (max-width: 768px) {
    .skill-level-option div {
        padding: 1rem;
    }
}

/* Dropdown scrollbar styles */
.custom-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: #CBD5E0 transparent;
}

.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: #CBD5E0;
    border-radius: 3px;
}

/* Dropdown menu styles */
#allergiesDropdown {
    max-height: 12rem;
    overflow-y: auto;
}

#allergiesDropdownButton:focus {
    outline: none;
    ring: 2px;
    ring-color: #10B981;
}
@media (max-width: 768px) {
    #toast {
        bottom: 20px;
    }
    
    #toast .bg-red-500 {
        font-size: 14px;
        line-height: 1.4;
    }
}
</style>
{% endblock %}


{% block content %}
<div class="min-h-screen bg-gradient-to-br from-green-50 via-emerald-100 to-teal-100">

    <!-- Main Content -->
    <div class="max-w-5xl mx-auto px-4 py-8">
        <div class="bg-white rounded-xl shadow-xl p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Generate Your Personalized Meal Plan</h2>
            
            {% if not has_subscription %}
            <div class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border-l-4 border-blue-500">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-500 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">You're using the free version</h3>
                        <div class="mt-2 text-sm text-blue-700">
                            <p>Some premium features are disabled. <a href="{% url 'pricing' %}" class="font-medium underline hover:text-blue-800 transition-colors duration-300">Upgrade now</a> to unlock all features.</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if has_maxed_trials %}
<div class="bg-white rounded-xl shadow-xl p-8 text-center">
    <div class="mx-auto w-24 h-24 bg-yellow-100 rounded-full flex items-center justify-center mb-6">
        <i class="fas fa-lock text-yellow-500 text-4xl"></i>
    </div>
    
    <h2 class="text-2xl font-bold text-gray-800 mb-4">You've Reached Your Free Trial Limit</h2>
    
    <p class="text-gray-600 mb-6 max-w-lg mx-auto">
        You've used all 3 of your free meal plan generations. Upgrade to continue creating personalized Nigerian meal plans!
    </p>
    
    <div class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-2xl mx-auto">
            <div class="bg-green-50 p-4 rounded-lg">
                <i class="fas fa-infinity text-green-500 text-2xl mb-2"></i>
                <h3 class="font-semibold text-gray-800">Unlimited Plans</h3>
                <p class="text-sm text-gray-600">Generate as many meal plans as you need</p>
            </div>
            
            <div class="bg-blue-50 p-4 rounded-lg">
                <i class="fas fa-robot text-blue-500 text-2xl mb-2"></i>
                <h3 class="font-semibold text-gray-800">AI Assistant</h3>
                <p class="text-sm text-gray-600">Get personalized cooking tips</p>
            </div>
            
            <div class="bg-purple-50 p-4 rounded-lg">
                <i class="fas fa-location-dot text-purple-500 text-2xl mb-2"></i>
                <h3 class="font-semibold text-gray-800">Store Locator</h3>
                <p class="text-sm text-gray-600">Find ingredients near you</p>
            </div>
        </div>
        
        <div class="flex flex-col items-center space-y-4">
            <a href="{% url 'pricing' %}" 
               class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-medium rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all duration-300 transform hover:scale-105">
                <i class="fas fa-crown mr-2"></i>
                Upgrade Now
            </a>
            
            <p class="text-sm text-gray-500">
                <i class="fas fa-shield-alt text-gray-400 mr-1"></i>
                30-day money-back guarantee
            </p>
        </div>
    </div>
</div>
{% else %}
{% if not has_subscription %}
<div class="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
    <div class="flex items-start">
        <div class="flex-shrink-0">
            <i class="fas fa-info-circle text-yellow-500 text-xl"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-yellow-800">Free Plan Limitations</h3>
            <div class="mt-2 text-sm text-yellow-700">
                <ul class="list-disc pl-5 space-y-1">
                    <li>Maximum 3 meal plans total</li>
                    <li>Maximum 3 days per plan</li>
                    <li>Breakfast and lunch only</li>
                    <li>No snacks included</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}


      <form id="mealPlanForm" 
      class="space-y-6" 
      method="POST" 
      action="{% url 'meal_generator' %}" 
      data-has-subscription="{{ has_subscription|yesno:'true,false' }}"
      data-subscription-type="{{ subscription_type }}"
      novalidate>
                {% csrf_token %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Basic Info Section -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>Basic Information
                            <span class="ml-2 px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Free</span>
                        </h3>
                        
                        <div class="space-y-4">
      
<!-- Dietary Style Selection -->
<div class="form-group">
    <label for="dietary_preferences" class="block text-gray-700 mb-2" id="dietary-label">
        <i class="fas fa-utensils mr-2"></i>Nigerian Dietary Style
        <span class="text-red-500">*</span>
    </label>
    <select id="dietary_preferences" 
            name="dietary_preferences" 
            class="form-select w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-300"
            aria-labelledby="dietary-label"
            aria-describedby="dietary-help" 
            required>
        <option value="">Select Your Preferred Style</option>
        {% for style, info in dietary_preferences.items %}
            <option value="{{ style }}" 
                    data-description="{{ info.description }}">
                {{ style|title|cut:"_" }}
            </option>
        {% endfor %}
    </select>
    <small id="dietary-help" class="block mt-2 text-sm text-gray-500 bg-gray-50 p-3 rounded-lg">
        <span id="preference-description" class="italic">Select a dietary style to see its description</span>
    </small>
</div>

<!-- Hidden input for cuisine type - will be set server-side -->
<input type="hidden" name="preferred_cuisine" value="">

<!-- Cuisine Type Selection -->
<div class="form-group">
    <label class="block text-gray-700 mb-2" for="preferred_cuisine">
        <i class="fas fa-globe-africa mr-2"></i>Nigerian Region
        <span class="text-red-500">*</span>
    </label>
    <select required id="preferred_cuisine" 
            name="preferred_cuisine" 
            class="form-select w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-300">
        <option value="">Select Region</option>
        <option value="Yoruba">Yoruba (Southwest)</option>
        <option value="Igbo">Igbo (Southeast)</option>
        <option value="Hausa">Hausa (North)</option>
        <option value="Contemporary">Contemporary Nigerian</option>
    </select>
</div>
                            
                            <div class="form-group">
                                <label class="block text-gray-700 mb-2" for="family_size">
                                    <i class="fas fa-users mr-2"></i>Number of People
                                    <span class="text-red-500">*</span>
                                </label>
                                <input type="number" 
                                       id="family_size" 
                                       name="family_size" 
                                       class="form-input w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-300"
                                       placeholder="Enter number of people" required>
                            </div>
                            
                            <!-- New Fields -->
                            <div class="form-group">
                                <label class="block text-gray-700 mb-2" for="plan_days">
                                    <i class="fas fa-calendar-day mr-2"></i>Number of Days
                                    <span class="text-red-500">*</span>
                                </label>
                                <input type="number" 
                                       id="plan_days" 
                                       name="plan_days" 
                                       class="form-input w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-300"
                                       placeholder="{% if not has_subscription %}Max: 3 days{% else %}Default: 7 days{% endif %}"
                                       value="{% if not has_subscription %}3{% else %}7{% endif %}"
                                       min="1"
                                       max="{% if not has_subscription %}3{% else %}14{% endif %}"
                                       {% if not has_subscription %}readonly{% endif %}>
                                {% if not has_subscription %}
                                <div class="mt-1 text-xs text-gray-500 flex items-center">
                                    <i class="fas fa-info-circle mr-1"></i> Free users limited to 3 days
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label class="block text-gray-700 mb-2" for="meals_per_day">
                                    <i class="fas fa-clock mr-2"></i>Meals Per Day
                                </label>
                                <select id="meals_per_day" 
                                        name="meals_per_day" 
                                        class="form-select w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-300"
                                        {% if not has_subscription %}disabled{% endif %}>
                                    <option value="2" selected>2 meals per day (Breakfast & Lunch)</option>
                                    {% if has_subscription %}
                                    <option value="3">3 meals per day</option>
                                    {% endif %}
                                </select>
                                {% if not has_subscription %}
                                <div class="mt-1 text-xs text-gray-500 flex items-center">
                                    <i class="fas fa-info-circle mr-1"></i> Free users limited to breakfast and lunch
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Hide snacks option for free users -->
                            {% if has_subscription %}
                            <div class="form-group">
                                <label class="flex items-center">
                                    <input type="checkbox" name="include_snacks" id="include_snacks" class="form-checkbox h-5 w-5 text-green-600" checked>
                                    <span class="ml-2 text-gray-700">Include Snacks</span>
                                </label>
                            </div>
                            {% endif %}
                            
                            <div class="form-group">
                                <label class="block text-gray-700 mb-2" for="budget">
                                    <i class="fas fa-wallet mr-2"></i>Total Budget (Optional)
                                </label>
                                <div class="relative rounded-md shadow-sm">
                                    <!-- <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500" id="currency-symbol">{{ supported_currencies|get_item:user_currency }}</span>
                                    </div> -->
                                    <input type="number" 
                                           id="budget" 
                                           name="budget" 
                                           class="form-input w-full pl-8 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-300"
                                           placeholder="Enter your budget"
                                           step="0.01">
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                        <select id="currency" 
                                                name="currency" 
                                                class="form-select h-full py-0 pl-2 pr-7 border-transparent bg-transparent text-gray-500 sm:text-sm rounded-md">
                                            {% for code, symbol in supported_currencies.items %}
                                                <option value="{{ code }}" {% if code == user_currency %}selected{% endif %}>
                                                    {{ code }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Premium Features Section -->
<!-- Premium Features Section -->
<div>
    <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
        <i class="fas fa-star text-yellow-500 mr-2"></i>Premium Options
        <span class="ml-2 px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">Premium</span>
    </h3>
    
    <div class="space-y-4 {% if not has_subscription %}opacity-60{% endif %}">
        <!-- Health Goals - Enhanced Input -->
        <div class="form-group">
            <label class="block text-gray-700 mb-2" for="health_goals">
                <i class="fas fa-heartbeat mr-2"></i>Health Goals
            </label>
            <div class="relative">
                <select id="health_goals" 
                        name="health_goals" 
                        class="form-select w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-300"
                        {% if not has_subscription %}disabled{% endif %}>
                    <option value="">Select Health Goal</option>
                    <option value="weight_loss">Weight Loss</option>
                    <option value="muscle_gain">Muscle Gain</option>
                    <option value="maintenance">Maintenance</option>
                    <option value="heart_health">Heart Health</option>
                    <option value="diabetes_friendly">Diabetes-Friendly</option>
                    <option value="energy_boost">Energy Boost</option>
                </select>
                {% if not has_subscription %}
                <div class="mt-1 text-xs text-gray-500 flex items-center">
                    <i class="fas fa-lock mr-1"></i> Premium feature
                </div>
                {% endif %}
            </div>
        </div>
        
<!-- Allergies & Restrictions - Enhanced Multi-Select Dropdown -->
<div class="form-group">
    <label class="block text-gray-700 mb-2" for="allergies">
        <i class="fas fa-exclamation-triangle mr-2"></i>Allergies & Restrictions
    </label>
    <div class="relative">
        <button id="allergiesDropdownButton" 
                data-dropdown-toggle="allergiesDropdown" 
                class="w-full text-left bg-white border border-gray-300 text-gray-700 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500 flex justify-between items-center"
                type="button">
            <span id="selectedAllergies" class="text-sm text-gray-500">Select allergies</span>
            <i class="fas fa-chevron-down text-gray-500"></i>
        </button>
        <div id="allergiesDropdown" 
             class="hidden z-10 w-full bg-white rounded-lg shadow-lg border border-gray-200 mt-2">
            <ul class="p-3 space-y-2 max-h-48 overflow-y-auto custom-scrollbar">
                <li>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="allergies" value="nuts" class="form-checkbox h-5 w-5 text-green-600">
                        <span class="text-sm text-gray-700">Nuts</span>
                    </label>
                </li>
                <li>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="allergies" value="dairy" class="form-checkbox h-5 w-5 text-green-600">
                        <span class="text-sm text-gray-700">Dairy</span>
                    </label>
                </li>
                <li>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="allergies" value="eggs" class="form-checkbox h-5 w-5 text-green-600">
                        <span class="text-sm text-gray-700">Eggs</span>
                    </label>
                </li>
                <li>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="allergies" value="soy" class="form-checkbox h-5 w-5 text-green-600">
                        <span class="text-sm text-gray-700">Soy</span>
                    </label>
                </li>
                <li>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="allergies" value="gluten" class="form-checkbox h-5 w-5 text-green-600">
                        <span class="text-sm text-gray-700">Gluten</span>
                    </label>
                </li>
                <li>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="allergies" value="shellfish" class="form-checkbox h-5 w-5 text-green-600">
                        <span class="text-sm text-gray-700">Shellfish</span>
                    </label>
                </li>
                <li>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="allergies" value="fish" class="form-checkbox h-5 w-5 text-green-600">
                        <span class="text-sm text-gray-700">Fish</span>
                    </label>
                </li>
            </ul>
        </div>
        {% if not has_subscription %}
        <div class="mt-1 text-xs text-gray-500 flex items-center">
            <i class="fas fa-lock mr-1"></i> Premium feature
        </div>
        {% endif %}
    </div>
</div>

        
<!-- Cooking Skill Level - Enhanced Input -->
<div class="form-group">
    <label class="block text-gray-700 mb-2" for="skill_level">
        <i class="fas fa-chart-line mr-2"></i>Cooking Skill Level
    </label>
    <div class="relative">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <label class="skill-level-option">
                <input type="radio" 
                       name="skill_level" 
                       value="Beginner" 
                       class="hidden" 
                       {% if not has_subscription %}disabled{% endif %}>
                <div class="p-4 text-center border rounded-lg cursor-pointer transition-all duration-200 hover:bg-green-50 {% if has_subscription %}hover:border-green-500{% endif %} flex flex-col items-center">
                    <i class="fas fa-seedling text-2xl mb-2 text-green-500"></i>
                    <div class="text-sm font-medium">Beginner</div>
                    <div class="text-xs text-gray-500 mt-1">Perfect for new cooks</div>
                </div>
            </label>
            <label class="skill-level-option">
                <input type="radio" 
                       name="skill_level" 
                       value="Intermediate" 
                       class="hidden" 
                       checked 
                       {% if not has_subscription %}disabled{% endif %}>
                <div class="p-4 text-center border rounded-lg cursor-pointer transition-all duration-200 hover:bg-green-50 {% if has_subscription %}hover:border-green-500{% endif %} flex flex-col items-center">
                    <i class="fas fa-utensils text-2xl mb-2 text-green-500"></i>
                    <div class="text-sm font-medium">Intermediate</div>
                    <div class="text-xs text-gray-500 mt-1">Comfortable in kitchen</div>
                </div>
            </label>
            <label class="skill-level-option">
                <input type="radio" 
                       name="skill_level" 
                       value="Advanced" 
                       class="hidden" 
                       {% if not has_subscription %}disabled{% endif %}>
                <div class="p-4 text-center border rounded-lg cursor-pointer transition-all duration-200 hover:bg-green-50 {% if has_subscription %}hover:border-green-500{% endif %} flex flex-col items-center">
                    <i class="fas fa-kitchen-set text-2xl mb-2 text-green-500"></i>
                    <div class="text-sm font-medium">Advanced</div>
                    <div class="text-xs text-gray-500 mt-1">Expert level cooking</div>
                </div>
            </label>
        </div>
        {% if not has_subscription %}
        <div class="mt-1 text-xs text-gray-500 flex items-center">
            <i class="fas fa-lock mr-1"></i> Premium feature
        </div>
        {% endif %}
    </div>
</div>



        {% if not has_subscription %}
        <div class="mt-4 bg-gradient-to-r from-yellow-50 to-amber-50 p-4 rounded-lg border border-yellow-200">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-crown text-yellow-500 text-xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800">Unlock Premium Features</h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        <p>Get personalized meal plans with detailed health goals, allergen controls, and skill-based recipes.</p>
                        <a href="{% url 'pricing' %}" class="mt-2 inline-block text-yellow-700 font-medium hover:text-yellow-800 underline">Upgrade Now</a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
                </div>
                
                <div class="border-t border-gray-200 pt-6">
                    <button type="submit" 
                            id="generateBtn" 
                            class="w-full md:w-auto bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-medium py-3 px-8 rounded-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center"
                            aria-label="Generate meal plan based on your preferences">
                      <i class="fas fa-magic mr-2" aria-hidden="true"></i>
                      <span id="generateBtnText">Surprise Me!</span>
                    </button>
                  </div>
                
                <!-- Hidden field to ensure snacks are properly tracked -->
                <input type="hidden" id="include_snacks_value" name="include_snacks_value" value="true">
            </form>
{% endif %}
        </div>
        
        <!-- Loading animation (initially hidden) - Animated SVG -->
        <div id="loading" class="hidden bg-white rounded-xl shadow-xl p-8 text-center" aria-live="polite" aria-busy="true">
            <div class="mx-auto w-40 h-40" aria-hidden="true">
                <!-- Animated cooking/food SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="mx-auto">
                    <style>
                        @keyframes steam {
                            0% { transform: translateY(0) scale(1); opacity: 0.8; }
                            50% { transform: translateY(-10px) scale(1.2); opacity: 0.5; }
                            100% { transform: translateY(-20px) scale(1.5); opacity: 0; }
                        }
                        @keyframes stir {
                            0% { transform: rotate(0deg); }
                            25% { transform: rotate(10deg); }
                            75% { transform: rotate(-10deg); }
                            100% { transform: rotate(0deg); }
                        }
                        .steam {
                            animation: steam 2s infinite ease-out;
                            transform-origin: center bottom;
                        }
                        .steam-1 { animation-delay: 0s; }
                        .steam-2 { animation-delay: 0.3s; }
                        .steam-3 { animation-delay: 0.6s; }
                        .spoon {
                            animation: stir 3s infinite ease-in-out;
                            transform-origin: 50% 80%;
                        }
                    </style>
                    
                    <!-- Pot -->
                    <path d="M50,120 C50,160 150,160 150,120 L150,100 L50,100 Z" fill="#4B5563"/>
                    <ellipse cx="100" cy="100" rx="50" ry="15" fill="#6B7280"/>
                    
                    <!-- Pot contents -->
                    <ellipse cx="100" cy="110" rx="40" ry="10" fill="#10B981"/>
                    
                    <!-- Pot handles -->
                    <path d="M45,110 C35,110 30,120 40,120" stroke="#374151" stroke-width="4" fill="none"/>
                    <path d="M155,110 C165,110 170,120 160,120" stroke="#374151" stroke-width="4" fill="none"/>
                    
                    <!-- Steam -->
                    <path class="steam steam-1" d="M90,90 Q95,75 100,90" stroke="#E5E7EB" stroke-width="3" fill="none"/>
                    <path class="steam steam-2" d="M100,90 Q105,70 110,90" stroke="#E5E7EB" stroke-width="3" fill="none"/>
                    <path class="steam steam-3" d="M110,90 Q115,75 120,90" stroke="#E5E7EB" stroke-width="3" fill="none"/>
                    
                    <!-- Spoon -->
                    <g class="spoon">
                        <path d="M130,80 L120,110" stroke="#92400E" stroke-width="3" fill="none"/>
                        <ellipse cx="130" cy="75" rx="8" ry="4" fill="#92400E"/>
                    </g>
                </svg>
            </div>
            <h3 class="mt-3 text-xl font-semibold text-gray-800">Generating your personalized meal plan...</h3>
            <p class="text-gray-600">This may take a minute. We're crafting the perfect African meal plan for you.</p>
            <div class="sr-only" role="status">Please wait, generating your meal plan</div>
        </div>
        
        <!-- Results Section (initially hidden) -->
        <div id="results" class="hidden mt-4" aria-live="polite">
            <div class="bg-white rounded-xl shadow-xl p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Your Meal Plan</h3>
                    <div class="flex items-center space-x-4">
                        <button onclick="shareMealPlan()" 
                                class="inline-flex items-center px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors duration-200">
                            <i class="fas fa-share-alt mr-2"></i>
                            Share Meal Plan
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
<!-- Replace the current table structure with this -->
<div class="mb-8">
    <!-- Desktop View -->
    <div class="hidden md:block">
        <table id="mealPlanTable" class="w-full">
            <thead>
                <tr>
                    <th class="text-left py-3 px-4 font-semibold text-gray-800 bg-gray-100 rounded-tl-lg">Day</th>
                    <th class="text-left py-3 px-4 font-semibold text-orange-800 bg-orange-100">
                        <div class="flex items-center">
                            <i class="fas fa-sun text-orange-500 mr-2"></i>
                            <span>Breakfast</span>
                        </div>
                    </th>
                    <th class="text-left py-3 px-4 font-semibold text-green-800 bg-green-100">
                        <div class="flex items-center">
                            <i class="fas fa-utensils text-green-500 mr-2"></i>
                            <span>Lunch</span>
                        </div>
                    </th>
                    <th class="text-left py-3 px-4 font-semibold text-purple-800 bg-purple-100 include-snacks">
                        <div class="flex items-center">
                            <i class="fas fa-cookie text-purple-500 mr-2"></i>
                            <span>Snack</span>
                        </div>
                    </th>
                    <th class="text-left py-3 px-4 font-semibold text-blue-800 bg-blue-100">
                        <div class="flex items-center">
                            <i class="fas fa-moon text-blue-500 mr-2"></i>
                            <span>Dinner</span>
                        </div>
                    </th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-800 bg-gray-100 rounded-tr-lg">Actions</th>
                </tr>
            </thead>
            <tbody id="mealPlanBody">
                <!-- Dynamically populated -->
            </tbody>
        </table>
    </div>

    <!-- Mobile View -->
    <div class="md:hidden" id="mobileMealPlan">
        <!-- Cards will be rendered here -->
    </div>
</div>
                </div>
            </div>
            
            <!-- Recipe Details Modal (Initially Hidden) -->
            <div id="recipeModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
                <div class="modal-container bg-white rounded-xl max-w-2xl w-full mx-4 flex flex-col" style="height: 90vh;">
                    <!-- Modal header -->
                    <div class="flex-shrink-0 flex justify-between items-center p-6 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800" id="recipeTitle">Recipe Title</h3>
                        <button id="closeRecipeModal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- Tabs navigation -->
                    <div class="flex-shrink-0 border-b border-gray-200">
                        <div class="tabs-container">
                            <nav class="flex flex-nowrap min-w-full px-6" aria-label="Tabs">
                                <button id="tab-overview" class="recipe-tab active-tab px-4 py-3 text-sm font-medium border-b-2 border-green-500 text-green-600 flex items-center">
                                    <i class="fas fa-info-circle mr-2"></i>Overview
                                </button>
                                <button id="tab-ingredients" class="recipe-tab px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center">
                                    <i class="fas fa-list mr-2"></i>Ingredients
                                </button>
                                <button id="tab-instructions" class="recipe-tab px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center">
                                    <i class="fas fa-utensils mr-2"></i>Instructions
                                </button>
                                <button id="tab-nutrition" class="recipe-tab px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center">
                                    <i class="fas fa-heartbeat mr-2"></i>Nutrition
                                </button>
                            </nav>
                        </div>
                    </div>
                    
                    <!-- Tab content - scrollable container -->
                    <div class="tab-content-container flex-grow">
                        <!-- Overview Tab -->
                        <div id="content-overview" class="recipe-content custom-scrollbar block px-2 py-2">
                            <div class="space-y-4">
                                <h4 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                                    <i class="fas fa-info-circle text-green-500 mr-2"></i>About This Dish
                                </h4>
                                <p id="recipeDescription" class="text-gray-700">Recipe description goes here.</p>
                                
                                <div class="p-4 bg-green-50 rounded-lg">
                                    <h5 class="font-medium text-green-800 mb-2">Quick Info</h5>
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <div class="flex items-center">
                                            <i class="fas fa-clock text-green-600 mr-2"></i>
                                            <span>Prep: <span id="recipePrepTime">20 mins</span></span>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="fas fa-fire text-green-600 mr-2"></i>
                                            <span>Cook: <span id="recipeCookTime">45 mins</span></span>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="fas fa-users text-green-600 mr-2"></i>
                                            <span>Serves: <span id="recipeServings">4</span></span>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="fas fa-chart-simple text-green-600 mr-2"></i>
                                            <span>Difficulty: <span id="recipeDifficulty">Medium</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ingredients Tab -->
                        <div id="content-ingredients" class="recipe-content custom-scrollbar hidden px-2 py-2">
                            <div class="space-y-4">
                                <h4 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                                    <i class="fas fa-list text-green-500 mr-2"></i>What You'll Need
                                </h4>
                                <ul id="recipeIngredients" class="space-y-2">
                                    <!-- Dynamically populated -->
                                </ul>
                                
                                <div class="mt-6 flex flex-wrap gap-2">
                                    <!-- In the recipe ingredients tab -->
<div class="mt-6 flex flex-wrap gap-2">
    <button onclick="shareRecipeIngredients()" 
            class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium flex items-center">
        <i class="fab fa-whatsapp mr-1"></i> Share via WhatsApp
    </button>
</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Instructions Tab -->
                        <div id="content-nutrition" class="recipe-content custom-scrollbar hidden px-2 py-2">
                            <div class="space-y-4">
                                <h4 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                                    <i class="fas fa-heartbeat text-green-500 mr-2"></i>Nutritional Information
                                </h4>
                                <div class="p-4 bg-green-50 rounded-lg">
                                    <p class="text-sm text-gray-600 mb-3">Per serving (250g)</p>
                                    <div id="recipeNutrition" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div class="bg-white p-3 rounded-lg shadow-sm">
                                            <span class="block text-sm text-gray-600">Calories</span>
                                            <span class="block font-medium text-gray-800">350 kcal</span>
                                        </div>
                                        <div class="bg-white p-3 rounded-lg shadow-sm">
                                            <span class="block text-sm text-gray-600">Protein</span>
                                            <span class="block font-medium text-gray-800">15g</span>
                                        </div>
                                        <div class="bg-white p-3 rounded-lg shadow-sm">
                                            <span class="block text-sm text-gray-600">Carbohydrates</span>
                                            <span class="block font-medium text-gray-800">45g</span>
                                        </div>
                                        <div class="bg-white p-3 rounded-lg shadow-sm">
                                            <span class="block text-sm text-gray-600">Fat</span>
                                            <span class="block font-medium text-gray-800">12g</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Nutrition Tab -->
                        <div id="content-nutrition" class="recipe-content custom-scrollbar hidden px-2 py-2">
                            <div class="space-y-4">
                                <h4 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                                    <i class="fas fa-heartbeat text-green-500 mr-2"></i>Nutritional Information
                                </h4>
                                <div class="p-4 bg-green-50 rounded-lg">
                                    <p class="text-sm text-gray-600 mb-3">Nutritional values per serving</p>
                                    <div id="recipeNutrition" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <!-- Dynamically populated -->
                                    </div>
                                </div>
                                
                                {% if not has_subscription %}
                                <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-star text-yellow-500 text-xl"></i>
                                        </div>
                                        <div class="ml-3">
                                            <h3 class="text-sm font-medium text-yellow-800">Premium Features Available</h3>
                                            <div class="mt-2 text-sm text-yellow-700">
                                                <p>Upgrade to Premium for detailed nutritional analysis, video tutorials, and more cooking tips.</p>
                                                <a href="{% url 'pricing' %}" class="mt-2 inline-block text-yellow-700 font-medium hover:text-yellow-800 underline">Learn More</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <!-- Ingredients List -->
                <div class="bg-white rounded-xl shadow-xl p-6">
                    <!-- Update the shopping list header section -->
<div class="flex flex-col sm:flex-row justify-between items-center mb-4">
    <h3 class="text-xl font-bold text-gray-800 flex items-center mb-4 sm:mb-0">
        <i class="fas fa-shopping-basket text-green-500 mr-2"></i>Shopping List
    </h3>
    
    <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2">
        <!-- Share button -->
{% if has_subscription %}
<button onclick="shareShoppingList()" 
        class="w-full sm:w-auto p-2 rounded-lg bg-green-100 text-green-700 hover:bg-green-200 transition-colors duration-200 flex items-center justify-center">
    <i class="fas fa-share-alt mr-1"></i>
    <span>Share List</span>
</button>
{% endif %}
        
        <!-- Pagination controls -->
        <div class="flex items-center space-x-2 bg-gray-50 rounded-lg p-1">
            <button id="prevPage" class="p-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 disabled:opacity-50">
                <i class="fas fa-chevron-left"></i>
            </button>
            <span id="pageIndicator" class="px-3 text-sm">
                <span id="currentPage">1</span>/<span id="totalPages">1</span>
            </span>
            <button id="nextPage" class="p-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 disabled:opacity-50">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>
                    <div id="ingredientsList" class="space-y-2">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                

                {% if not has_subscription %}
                <!-- Premium Feature Card for Non-Subscribers -->
                <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl shadow-xl p-6 border border-yellow-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-star text-yellow-500 mr-2"></i>Premium Features
                    </h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 h-10 w-10 rounded-full bg-yellow-100 flex items-center justify-center">
                                <i class="fas fa-share-nodes text-yellow-600"></i>
                            </div>
                            <div class="ml-4">
                                <h4 class="text-md font-semibold text-gray-800">Advanced Sharing</h4>
                                <p class="text-sm text-gray-600">Share detailed meal plans and recipes with family and friends.</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <div class="flex-shrink-0 h-10 w-10 rounded-full bg-yellow-100 flex items-center justify-center">
                                <i class="fas fa-utensils text-yellow-600"></i>
                            </div>
                            <div class="ml-4">
                                <h4 class="text-md font-semibold text-gray-800">Detailed Recipes</h4>
                                <p class="text-sm text-gray-600">Access complete recipes with step-by-step instructions.</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <div class="flex-shrink-0 h-10 w-10 rounded-full bg-yellow-100 flex items-center justify-center">
                                <i class="fas fa-heartbeat text-yellow-600"></i>
                            </div>
                            <div class="ml-4">
                                <h4 class="text-md font-semibold text-gray-800">Nutritional Information</h4>
                                <p class="text-sm text-gray-600">Get detailed nutritional breakdown for each meal.</p>
                            </div>
                        </div>
                        
                        <a href="{% url 'pricing' %}" class="block w-full mt-6 text-center bg-gradient-to-r from-yellow-500 to-amber-500 text-white font-medium py-2 px-4 rounded-lg hover:from-yellow-600 hover:to-amber-600 transition-colors duration-300">
                            Upgrade Your Account
                        </a>
                    </div>
                </div>
                {% else %}
                <!-- Premium Feature Card for Subscribers -->
                <div class="bg-gradient-to-br from-green-50 to-emerald-100 rounded-xl shadow-xl p-6 border border-green-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-crown text-green-500 mr-2"></i>Premium Features Unlocked
                    </h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 h-10 w-10 rounded-full bg-green-100 flex items-center justify-center">
                                <i class="fas fa-share-nodes text-green-600"></i>
                            </div>
                            <div class="ml-4">
                                <h4 class="text-md font-semibold text-gray-800">Advanced Sharing</h4>
                                <p class="text-sm text-gray-600">You can now share detailed meal plans and recipes with family and friends.</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <div class="flex-shrink-0 h-10 w-10 rounded-full bg-green-100 flex items-center justify-center">
                                <i class="fas fa-utensils text-green-600"></i>
                            </div>
                            <div class="ml-4">
                                <h4 class="text-md font-semibold text-gray-800">Detailed Recipes</h4>
                                <p class="text-sm text-gray-600">Access complete recipes with step-by-step instructions.</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <div class="flex-shrink-0 h-10 w-10 rounded-full bg-green-100 flex items-center justify-center">
                                <i class="fas fa-heartbeat text-green-600"></i>
                            </div>
                            <div class="ml-4">
                                <h4 class="text-md font-semibold text-gray-800">Nutritional Information</h4>
                                <p class="text-sm text-gray-600">Get detailed nutritional breakdown for each meal.</p>
                            </div>
                        </div>
                        
                        <p class="mt-6 text-center text-sm text-gray-600">Thank you for being a premium subscriber! Enjoy your exclusive features.</p>
                    </div>
                </div>
                {% endif %}

            </div>
            
            <!-- Download Buttons -->
            <div class="flex flex-wrap gap-4">
                
                {% if not has_subscription %}
                <div class="ml-auto">
                    <a href="{% url 'pricing' %}" class="inline-block bg-gradient-to-r from-indigo-500 to-blue-500 hover:from-indigo-600 hover:to-blue-600 text-white font-medium px-6 py-3 rounded-lg transition-colors duration-300">
                        <i class="fas fa-crown mr-2"></i>Unlock Premium Features
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-4 left-4 right-4 transform translate-y-full opacity-0 transition-all duration-300 z-50">
    <div class="bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg flex items-center mx-auto max-w-md">
        <i class="fas fa-exclamation-circle mr-2 text-xl"></i>
        <span id="toastMessage" class="text-sm font-medium flex-1"></span>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables -->
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>

<script>
// Global variables
const recipeCache = new Map();
window.groceryList = [];
let currentPage = 1;
const itemsPerPage = 10;

const hasSubscription = document.getElementById('mealPlanForm').dataset.hasSubscription === 'true';



// Update the form validation function
function validateSubscriptionForm(e) {
    const subscriptionType = document.getElementById('mealPlanForm').dataset.subscriptionType;
    const planDays = parseInt(document.getElementById('plan_days').value);

    switch(subscriptionType) {
        case 'free':
            if (planDays > 3) {
                e.preventDefault();
                showToast('Free users can only generate meal plans for up to 3 days', 3000);
                return false;
            }
            break;

        case 'pay_once':
            if (planDays > 7) {
                e.preventDefault();
                showToast('Pay Once users can generate meal plans for up to 7 days', 3000);
                return false;
            }
            break;

        case 'weekly':
            if (planDays > 14) {
                e.preventDefault();
                showToast('Weekly users can generate meal plans for up to 14 days', 3000);
                return false;
            }
            break;
    }
    return true;
}




function showToast(message, duration = 3000) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    
    // Clear any existing timeout
    if (window.toastTimeout) {
        clearTimeout(window.toastTimeout);
    }
    
    // Update message and show toast
    toastMessage.textContent = message;
    toast.classList.remove('translate-y-full', 'opacity-0');
    toast.classList.add('translate-y-0', 'opacity-100');
    
    // Set new timeout
    window.toastTimeout = setTimeout(() => {
        toast.classList.add('translate-y-full', 'opacity-0');
        toast.classList.remove('translate-y-0', 'opacity-100');
    }, duration);
}

function handleRecipeError(error) {
    console.error('Error:', error);
    
    let errorMessage = 'An unexpected error occurred while loading the recipe.';
    if (error.message === 'Recipe not found') {
        errorMessage = 'This recipe could not be found.';
    } else if (error.message.includes('HTTP error')) {
        errorMessage = 'There was a problem connecting to the server.';
    }

    $('#recipeTitle').html('<i class="fas fa-exclamation-circle text-red-500 mr-2"></i>Error Loading Recipe');
    $('#content-overview').html(`
        <div class="p-4 bg-red-50 rounded-lg">
            <p class="text-red-600">${errorMessage}</p>
            <p class="text-red-500 text-sm mt-2">${error.message}</p>
            <button onclick="$('#recipeModal').addClass('hidden')" 
                    class="mt-4 px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200">
                Close
            </button>
        </div>
    `);
}

function showProgressiveLoading() {
    // Clear any existing content first
    $('#recipeDescription').empty();
    $('#recipeIngredients').empty();
    $('#recipeInstructions').empty();
    $('#recipeNutrition').empty();
    $('#content-overview .cooking-tips').remove();
    
    // Add loading animation for description
    $('#recipeDescription').html('<div class="recipe-loading-animation animate-pulse bg-gray-200 h-20 rounded-lg mb-4"></div>');
    
    // Add loading animation for quick info
    $('#recipePrepTime').html('<span class="recipe-loading-animation animate-pulse bg-gray-200 inline-block w-16 h-4 rounded"></span>');
    $('#recipeCookTime').html('<span class="recipe-loading-animation animate-pulse bg-gray-200 inline-block w-16 h-4 rounded"></span>');
    $('#recipeServings').html('<span class="recipe-loading-animation animate-pulse bg-gray-200 inline-block w-8 h-4 rounded"></span>');
    $('#recipeDifficulty').html('<span class="recipe-loading-animation animate-pulse bg-gray-200 inline-block w-20 h-4 rounded"></span>');
    
    // Add loading animations for other sections
    $('#recipeIngredients').html('<div class="recipe-loading-animation space-y-2">' + Array(5).fill('<div class="animate-pulse bg-gray-200 h-6 rounded"></div>').join('') + '</div>');
    $('#recipeInstructions').html('<div class="recipe-loading-animation space-y-4">' + Array(3).fill('<div class="animate-pulse bg-gray-200 h-16 rounded-lg"></div>').join('') + '</div>');
    $('#recipeNutrition').html('<div class="recipe-loading-animation grid grid-cols-2 gap-4">' + Array(4).fill('<div class="animate-pulse bg-gray-200 h-12 rounded"></div>').join('') + '</div>');
}


function showPremiumFeaturePrompt() {
    if (confirm('This sharing feature is only available to premium users. Would you like to upgrade now?')) {
        window.location.href = "{% url 'pricing' %}";
    }
}

// Add click handlers for sharing buttons for free users
if (!hasSubscription) {
    $(document).on('click', '.share-button', function(e) {
        e.preventDefault();
        showPremiumFeaturePrompt();
    });
}





function viewRecipe(dayIndex, mealType) {
    const cacheKey = `${window.currentMealPlanId}-${dayIndex}-${mealType}`;
    
    // Show loading state in modal
    $('#recipeModal').removeClass('hidden');
    $('#recipeTitle').html('<i class="fas fa-spinner fa-spin mr-2"></i> Loading Recipe...');
    
    // Clear any previous content and show loading animations
    showProgressiveLoading();
    
    // Check cache first
    if (recipeCache.has(cacheKey)) {
        console.log('Using cached recipe data');
        $('.recipe-loading-animation').remove();
        updateRecipeModal(recipeCache.get(cacheKey));
        return;
    }

    // Add CSRF token to headers
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Fetch recipe details
    fetch(`/api/recipe-details/${window.currentMealPlanId}/${dayIndex}/${mealType}/`, {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            throw new Error(data.error || 'Failed to load recipe');
        }
        
        console.log('Received recipe data:', data);
        recipeCache.set(cacheKey, data);
        $('.recipe-loading-animation').remove();
        updateRecipeModal(data);
        preloadNextRecipes(dayIndex, mealType);
    })
    .catch(error => {
        console.error('Error fetching recipe:', error);
        $('.recipe-loading-animation').remove();
        handleRecipeError(error);
        showToast('Unable to load recipe details. Please try again later.', 3000);
        
        setTimeout(() => {
            $('#recipeModal').addClass('hidden');
        }, 3000);
    });
}



// Preloading Functions
function preloadNextRecipes(currentDayIndex, currentMealType) {
    const mealTypes = ['breakfast', 'lunch', 'snack', 'dinner'];
    const currentMealIndex = mealTypes.indexOf(currentMealType);
    
    // Preload next meal in the same day
    if (currentMealIndex < mealTypes.length - 1) {
        preloadRecipe(currentDayIndex, mealTypes[currentMealIndex + 1]);
    }
    // Preload first meal of next day
    else if (currentDayIndex < window.currentMealPlan.length - 1) {
        preloadRecipe(currentDayIndex + 1, mealTypes[0]);
    }
}

function preloadRecipe(dayIndex, mealType) {
    const cacheKey = `${window.currentMealPlanId}-${dayIndex}-${mealType}`;
    if (!recipeCache.has(cacheKey)) {
        fetch(`/api/recipe-details/${window.currentMealPlanId}/${dayIndex}/${mealType}/`)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(recipeData => {
                recipeCache.set(cacheKey, recipeData);
            })
            .catch(() => {}); // Silently fail for preloading
    }
}


function shareDayMealPlan(dayIndex) {
    const subscriptionType = document.getElementById('mealPlanForm').dataset.subscriptionType;
    if (subscriptionType === 'free') {
        showToast('Sharing is a premium feature. Please upgrade to share meal plans.', 3000);
        return;
    }

    const day = window.currentMealPlan[dayIndex];
    
    const text = ` My NaijaPlate Meal Plan for ${day.day}:\n\n` +
        Object.entries(day.meals)
            .filter(([_, meal]) => meal !== null)
            .map(([type, meal]) => {
                const emoji = type === 'breakfast' ? '' :
                            type === 'lunch' ? '' :
                            type === 'snack' ? '' : '';
                return `${emoji} ${type.charAt(0).toUpperCase() + type.slice(1)}: ${meal}`;
            })
            .join('\n');

    shareViaWhatsApp(text + '\n\n Generated by NaijaPlate');
}




function shareShoppingList() {
    const subscriptionType = document.getElementById('mealPlanForm').dataset.subscriptionType;
    if (subscriptionType === 'free') {
        showToast('Sharing is a premium feature. Please upgrade to share shopping lists.', 3000);
        return;
    }

    
    if (!window.groceryList || window.groceryList.length === 0) {
        alert('No shopping list available. Please generate a meal plan first.');
        return;
    }

    let text = " My NaijaPlate Shopping List:\n\n";
    text += window.groceryList.map(item => ` ${typeof item === 'string' ? item : item.name}`).join('\n');
    text += "\n\n Generated by NaijaPlate";

    shareViaWhatsApp(text);
}


function shareRecipeIngredients() {
    const title = $('#recipeTitle').text();
    const ingredients = $('#recipeIngredients li span')
        .map(function() { return $(this).text(); })
        .get();
    
    const text = ` ${title}\n\nIngredients:\n` +
        ingredients.map(ingredient => ` ${ingredient}`).join('\n') +
        '\n\n Generated by NaijaPlate';
    
    shareViaWhatsApp(text);
}

function updateRecipeModal(recipeData) {
    console.log('Recipe Data:', recipeData); // Debug log
    
    // Helper function to clean HTML content
    function cleanHtmlContent(content) {
        if (!content) return '';
        return content.replace(/<div[^>]*>(.*?)<\/div>/g, '$1')
                     .replace(/<a\s+[^>]*>(.*?)<\/a>/g, '$1')
                     .replace(/&quot;/g, '"')
                     .replace(/&amp;/g, '&')
                     .replace(/&lt;/g, '<')
                     .replace(/&gt;/g, '>')
                     .replace(/\[link to.*?\]/g, '')
                     .replace(/\ud83d\udccd/g, '') // Remove map pin emoji
                     .trim();
    }
    
    // Update title
    $('#recipeTitle').text(recipeData.title || 'Recipe Details');
    
    // IMPORTANT: Clear all content areas first to remove loading animations
    $('#recipeDescription').empty();
    $('#recipeIngredients').empty();
    $('#recipeInstructions').empty();
    $('#recipeNutrition').empty();
    $('#content-overview .cooking-tips').remove();
    
    // Update description
    if (recipeData.description) {
        $('#recipeDescription').html(cleanHtmlContent(recipeData.description));
    } else {
        $('#recipeDescription').html('No description available.');
    }
    
    // Update quick info
    $('#recipePrepTime').text(recipeData.prepTime || 'N/A');
    $('#recipeCookTime').text(recipeData.cookTime || 'N/A');
    $('#recipeServings').text(recipeData.servings || '4');
    $('#recipeDifficulty').text(recipeData.difficulty || 'Intermediate');
    
    // Update ingredients
    console.log('Updating ingredients:', recipeData.ingredients); // Debug log
    if (Array.isArray(recipeData.ingredients) && recipeData.ingredients.length > 0) {
        let ingredientsHtml = '';
        recipeData.ingredients.forEach(ingredient => {
            ingredientsHtml += `
                <li class="flex items-center p-2 hover:bg-green-50 rounded-lg transition-colors duration-200">
                    <i class="fas fa-check text-green-500 mr-2"></i>
                    <span>${cleanHtmlContent(ingredient)}</span>
                </li>
            `;
        });
        $('#recipeIngredients').html(ingredientsHtml);
    } else {
        $('#recipeIngredients').html('<li class="text-gray-500">No ingredients listed</li>');
    }
    
    // Update instructions
    console.log('Updating instructions:', recipeData.instructions); // Debug log
    if (Array.isArray(recipeData.instructions) && recipeData.instructions.length > 0) {
        let instructionsHtml = '';
        recipeData.instructions.forEach((step, index) => {
            instructionsHtml += `
                <li class="flex items-start mb-4">
                    <div class="flex-shrink-0 h-6 w-6 bg-green-100 text-green-800 rounded-full flex items-center justify-center mr-3">
                        ${index + 1}
                    </div>
                    <p class="flex-1">${cleanHtmlContent(step)}</p>
                </li>
            `;
        });
        $('#recipeInstructions').html(instructionsHtml);
    } else {
        $('#recipeInstructions').html('<li class="text-gray-500">No instructions available</li>');
    }
    
    // Update nutrition
    console.log('Updating nutrition:', recipeData.nutrition); // Debug log
    if (recipeData.nutrition && typeof recipeData.nutrition === 'object') {
        let nutritionHtml = '';
        Object.entries(recipeData.nutrition).forEach(([key, value]) => {
            nutritionHtml += `
                <div class="bg-white p-3 rounded-lg shadow-sm">
                    <span class="block text-sm text-gray-600 capitalize">${key.replace(/_/g, ' ')}</span>
                    <span class="block font-medium text-gray-800">${value}</span>
                </div>
            `;
        });
        $('#recipeNutrition').html(nutritionHtml);
    } else {
        $('#recipeNutrition').html('<div class="text-gray-500">No nutritional information available</div>');
    }
    
    // Add tips section
    console.log('Updating tips:', recipeData.tips); // Debug log
    if (Array.isArray(recipeData.tips) && recipeData.tips.length > 0) {
        let tipsHtml = '<div class="mt-6 bg-yellow-50 rounded-lg p-4 cooking-tips">';
        tipsHtml += '<h5 class="font-medium text-yellow-800 mb-3">Cooking Tips</h5>';
        
        recipeData.tips.forEach(tip => {
            tipsHtml += `
                <div class="flex items-start mb-3">
                    <i class="fas fa-lightbulb text-yellow-500 mt-1 mr-2"></i>
                    <p class="flex-1 text-gray-700">${cleanHtmlContent(tip)}</p>
                </div>
            `;
        });
        
        tipsHtml += '</div>';
        $('#content-overview').append(tipsHtml);
    }
    

    if (recipeData.isNewlyGenerated) {
        const toastMessage = `Recipe "${recipeData.title}" has been automatically saved to your collection! `;
        showToast(toastMessage);
    }


    // Show overview tab and ensure loading animations are removed
    $('.recipe-content').addClass('hidden');
    $('#content-overview').removeClass('hidden');
    
    // Reset tab states
    $('.recipe-tab').removeClass('active-tab text-green-600 border-green-500')
                   .addClass('text-gray-500 border-transparent');
    $('#tab-overview').addClass('active-tab text-green-600 border-green-500')
                     .removeClass('text-gray-500 border-transparent');
                     
    // Force removal of any remaining loading animations
    $('.animate-pulse').remove();
}

// Add this to your JavaScript code
function getUserLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject('Geolocation is not supported by your browser');
            return;
        }

        navigator.geolocation.getCurrentPosition(
            position => resolve({
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
            }),
            error => reject(error)
        );
    });
}


if (!{{ has_subscription|yesno:"true,false" }}) {
    // Set default values for free users
    $('#plan_days').val('3').attr('max', '3');
    $('#meals_per_day').val('2');
    $('#include_snacks').prop('checked', false);
    
    // Disable dinner and snacks columns in the meal plan table
    $('.include-snacks').hide();
    $('th:contains("Dinner")').hide();
    $('td:nth-child(5)').hide();
    
    // Add form submission validation
    $('#mealPlanForm').on('submit', function(e) {
        const planDays = parseInt($('#plan_days').val());
        if (planDays > 3) {
            e.preventDefault();
            showToast('Free users can only generate meal plans for up to 3 days', 3000);
            return false;
        }
    });
}


// Meal Plan Rendering Functions
// Modify the renderDesktopMealPlan function
function renderDesktopMealPlan(mealPlanData) {
    // First, check if snacks are included
    const includeSnacks = hasSubscription && document.getElementById('include_snacks').checked;
    const mealsPerDay = hasSubscription ? parseInt(document.getElementById('meals_per_day').value) : 2;

    // Update table headers first
    let headerHtml = `
        <tr>
            <th class="text-left py-3 px-4 font-semibold text-gray-800 bg-gray-100 rounded-tl-lg">Day</th>
            ${mealsPerDay >= 2 ? `
                <th class="text-left py-3 px-4 font-semibold text-orange-800 bg-orange-100">
                    <div class="flex items-center">
                        <i class="fas fa-sun text-orange-500 mr-2"></i>
                        <span>Breakfast</span>
                    </div>
                </th>
            ` : ''}
            <th class="text-left py-3 px-4 font-semibold text-green-800 bg-green-100">
                <div class="flex items-center">
                    <i class="fas fa-utensils text-green-500 mr-2"></i>
                    <span>Lunch</span>
                </div>
            </th>
            ${includeSnacks ? `
                <th class="text-left py-3 px-4 font-semibold text-purple-800 bg-purple-100">
                    <div class="flex items-center">
                        <i class="fas fa-cookie text-purple-500 mr-2"></i>
                        <span>Snack</span>
                    </div>
                </th>
            ` : ''}
            ${mealsPerDay >= 3 ? `
                <th class="text-left py-3 px-4 font-semibold text-blue-800 bg-blue-100">
                    <div class="flex items-center">
                        <i class="fas fa-moon text-blue-500 mr-2"></i>
                        <span>Dinner</span>
                    </div>
                </th>
            ` : ''}
            <th class="text-left py-3 px-4 font-semibold text-gray-800 bg-gray-100 rounded-tr-lg">Actions</th>
        </tr>
    `;

    // Update meal rows
    let mealPlanHtml = mealPlanData.map((day, index) => `
        <tr class="border-b border-gray-200 hover:bg-opacity-80 transition-colors duration-150">
            <td class="py-3 px-4 font-medium bg-gray-100">${day.day}</td>
            ${mealsPerDay >= 2 ? `
                <td class="py-3 px-4 bg-orange-100">
                    <div class="mb-2 p-2 bg-white bg-opacity-60 rounded-lg border border-orange-200">
                        ${day.meals.breakfast || 'No Meal'}
                    </div>
                </td>
            ` : ''}
            <td class="py-3 px-4 bg-green-100">
                <div class="mb-2 p-2 bg-white bg-opacity-60 rounded-lg border border-green-200">
                    ${day.meals.lunch || 'No Meal'}
                </div>
            </td>
            ${includeSnacks ? `
                <td class="py-3 px-4 bg-purple-100">
                    <div class="mb-2 p-2 bg-white bg-opacity-60 rounded-lg border border-purple-200">
                        ${day.meals.snack || 'No Snack'}
                    </div>
                </td>
            ` : ''}
            ${mealsPerDay >= 3 ? `
                <td class="py-3 px-4 bg-blue-100">
                    <div class="mb-2 p-2 bg-white bg-opacity-60 rounded-lg border border-blue-200">
                        ${day.meals.dinner || 'No Meal'}
                    </div>
                </td>
            ` : ''}
<td class="py-3 px-4 bg-gray-100">
    ${hasSubscription ? `
    <button onclick="shareDayMealPlan(${index})" 
            class="text-xs bg-white hover:bg-green-100 text-green-800 px-3 py-1 rounded transition-colors duration-200 border border-green-300 w-full mb-2">
        <i class="fab fa-whatsapp mr-1"></i> Share Day
    </button>
    ` : ''}
</td>
        </tr>
    `).join('');

    $('#mealPlanTable thead').html(headerHtml);
    $('#mealPlanBody').html(mealPlanHtml);
}


function renderMobileMealPlan(mealPlanData) {
    const includeSnacks = hasSubscription && document.getElementById('include_snacks').checked;
    const mealsPerDay = hasSubscription ? parseInt(document.getElementById('meals_per_day').value) : 2;
    
    let html = '';
    mealPlanData.forEach((day, index) => {
        html += `
            <div class="mb-6 bg-white rounded-lg shadow-md overflow-hidden">
                <div class="bg-gray-100 p-4 flex justify-between items-center">
                    <span class="font-semibold">${day.day}</span>
                    ${hasSubscription ? `
                    <button onclick="shareDayMealPlan(${index})" 
                            class="text-xs bg-white hover:bg-green-100 text-green-800 px-3 py-1 rounded-full transition-colors duration-200 border border-green-300">
                        <i class="fab fa-whatsapp mr-1"></i> Share
                    </button>
                    ` : ''}
                </div>
                <div class="p-4 space-y-4">
                    ${Object.entries(day.meals)
                        .filter(([type, meal]) => {
                            // Filter meals based on settings
                            if (type === 'snack' && !includeSnacks) return false;
                            if (type === 'breakfast' && mealsPerDay < 2) return false;
                            if (type === 'dinner' && mealsPerDay < 3) return false;
                            return meal !== null;
                        })
                        .map(([type, meal]) => `
                            <div class="bg-${type === 'breakfast' ? 'orange' : type === 'lunch' ? 'green' : type === 'snack' ? 'purple' : 'blue'}-50 p-3 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="font-medium capitalize">${type}</h3>
                                    <div class="flex items-center space-x-2">
                                        <button onclick="viewRecipe(${index}, '${type}')"
                                                class="text-xs bg-white hover:bg-opacity-90 px-2 py-1 rounded-full transition-colors duration-200">
                                            <i class="fas fa-book-open mr-1"></i> Recipe
                                        </button>
                                    </div>
                                </div>
                                <p class="text-sm">${meal}</p>
                            </div>
                        `).join('')}
                </div>
            </div>
        `;
    });
    $('#mobileMealPlan').html(html);
}

// Shopping List Functions
function updateShoppingList() {
    // Filter the raw grocery list
    const filteredList = filterShoppingList(window.groceryList);

    // Paginate the filtered list
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const itemsToShow = filteredList.slice(startIndex, endIndex);

    // Generate HTML for the filtered list
    let ingredientsHtml = itemsToShow.map(ingredient => `
        <div class="flex items-center p-3 rounded-lg hover:bg-green-50 transition-colors duration-200">
            <i class="fas fa-check-circle text-green-500 mr-3"></i>
            <span class="text-gray-800">${ingredient}</span>
        </div>
    `).join('');

    // Update the shopping list container
    $('#ingredientsList').html(ingredientsHtml);

    // Update pagination
    $('#currentPage').text(currentPage);
    $('#totalPages').text(Math.ceil(filteredList.length / itemsPerPage));

    // Update pagination buttons
    $('#prevPage').prop('disabled', currentPage === 1);
    $('#nextPage').prop('disabled', currentPage === Math.ceil(filteredList.length / itemsPerPage));
}


// Sharing Functions
function shareMealPlan() {
    if (!hasSubscription) {
        showToast('Sharing is a premium feature. Please upgrade to share meal plans.', 3000);
        return;
    }

    if (!window.currentMealPlan || window.currentMealPlan.length === 0) {
        alert('No meal plan available. Please generate a meal plan first.');
        return;
    }

    const text = " My NaijaPlate Meal Plan:\n\n" + 
        window.currentMealPlan.map(day => {
            return ` ${day.day}:\n` +
                Object.entries(day.meals)
                    .filter(([_, meal]) => meal !== null)
                    .map(([type, meal]) => {
                        const emoji = type === 'breakfast' ? '' :
                                    type === 'lunch' ? '' :
                                    type === 'snack' ? '' : '';
                        return `${emoji} ${type.charAt(0).toUpperCase() + type.slice(1)}: ${meal}`;
                    })
                    .join('\n');
        }).join('\n\n');

    shareViaWhatsApp(text + '\n\n Generated by NaijaPlate');
}

function shareViaWhatsApp(text) {
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(whatsappUrl, '_blank');
}


function filterShoppingList(rawList) {
    // Define invalid patterns for filtering
    const invalidPatterns = [
        /^\d+\.\s/, // Matches items starting with "1. ", "2. ", etc.
        /make it/i, // Matches "Make it kid-friendly..."
        /recipe variations/i, // Matches "Recipe Variations:"
        /note:/i, // Matches "Note: If any of these ingredients..."
        /since/i, // Matches "Since you are on a Kosher diet..."
        /add/i, // Matches "Add extra spice..."
        /\(.*?\)/, // Matches parentheses with explanations (e.g., "Cocoyam (Ede ofe...)")
        /for/i, // Matches "Black Eyed Peas (for Akara/Bean Cake)"
        /ensure/i, // Matches "Ensure the oil used for frying..."
        /substitute/i, // Matches "You can substitute them with..."
        /use/i, // Matches "Use spinach in place of bitter leaves..."
    ];

    // Filter the list
    const filteredList = rawList.filter(item => {
        // Check if the item matches any invalid pattern
        return !invalidPatterns.some(pattern => pattern.test(item));
    });

    return filteredList;
}


// Document Ready
$(document).ready(function() {

    // Add this to your document ready function
$('#meals_per_day, #include_snacks').on('change', function() {
    if (window.currentMealPlan) {
        if (window.innerWidth < 768) {
            renderMobileMealPlan(window.currentMealPlan);
        } else {
            renderDesktopMealPlan(window.currentMealPlan);
        }
    }
});
    // Form submission handler
    $('#mealPlanForm').on('submit', function(e) {
    e.preventDefault();

    // Define required fields with their display names
    const requiredFields = [
        { id: 'dietary_preferences', name: 'Dietary Preferences' },
        { id: 'preferred_cuisine', name: 'Nigerian Cuisine Type' },
        { id: 'family_size', name: 'Number of People' },
        { id: 'plan_days', name: 'Number of Days' },
        { id: 'meals_per_day', name: 'Meals Per Day' }
    ];
    
    let isValid = true;
    let firstInvalidField = null;
    let missingFields = [];

    $('.form-input, .form-select').removeClass('border-red-500');
    
    requiredFields.forEach(field => {
        const element = $(`#${field.id}`);
        const value = element.val();
        
        if (!value || value.trim() === '') {
            isValid = false;
            element.addClass('border-red-500');
            missingFields.push(field.name);
            
            if (!firstInvalidField) {
                firstInvalidField = element;
            }
        } else {
            element.removeClass('border-red-500');
        }
    });
    
    if (!isValid) {
        // Show toast with specific missing fields
        const errorMessage = `Please fill in: ${missingFields.join(', ')}`;
        showToast(errorMessage, 5000); // Show for 5 seconds

        // Scroll to the first invalid field with smooth behavior
        if (firstInvalidField) {
            const offset = firstInvalidField.offset().top - 100;
            $('html, body').animate({
                scrollTop: offset
            }, {
                duration: 500,
                complete: function() {
                    // Add a temporary highlight effect
                    firstInvalidField
                        .addClass('ring-2 ring-red-500')
                        .delay(2000)
                        .queue(function(next) {
                            $(this).removeClass('ring-2 ring-red-500');
                            next();
                        });
                }
            });
        }
        
        return;
    }

    // Rest of your form submission code...
    $('#mealPlanForm').addClass('hidden');
    $('#loading').removeClass('hidden');
    
    const formData = new FormData(this);
        
        $.ajax({
            url: '{% url "meal_generator" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
    console.log('Response from server:', response);
    $('#loading').addClass('hidden');
    
    if (response.success) {
        console.log('Meal plan generated successfully');
        window.currentMealPlanId = response.meal_plan_id;
        window.currentMealPlan = response.meal_plan;
        window.groceryList = filterShoppingList(response.grocery_list);
        $('#results').removeClass('hidden');
        
        if (response.subscription_deactivated) {
            console.log('Subscription deactivated');
            showToast('Your one-time meal plan has been generated. Your subscription is now complete.', 5000);
            setTimeout(() => {
                window.location.href = "{% url 'pricing' %}";
            }, 6000);
        }
        
        if (window.innerWidth < 768) {
            renderMobileMealPlan(response.meal_plan);
        } else {
            renderDesktopMealPlan(response.meal_plan);
        }
        updateShoppingList();
    } else if (response.requires_upgrade) {
        alert(response.message);
        window.location.href = "{% url 'pricing' %}";
    }

},
            error: function(xhr, status, error) {
                $('#loading').addClass('hidden');
                $('#mealPlanForm').removeClass('hidden');
                alert('Error generating meal plan: ' + error);
            }
        });
    });

    // Event Listeners
    $('#nextPage').on('click', () => {
        if (currentPage < Math.ceil(window.groceryList.length / itemsPerPage)) {
            currentPage++;
            updateShoppingList();
        }
    });
    
    $('#prevPage').on('click', () => {
        if (currentPage > 1) {
            currentPage--;
            updateShoppingList();
        }
    });
    
    // Recipe modal tabs
    $('.recipe-tab').on('click', function() {
        $('.recipe-tab').removeClass('active-tab text-green-600 border-green-500')
                       .addClass('text-gray-500 border-transparent');
        $(this).addClass('active-tab text-green-600 border-green-500')
               .removeClass('text-gray-500 border-transparent');
        
        $('.recipe-content').addClass('hidden');
        $(`#content-${$(this).attr('id').replace('tab-', '')}`).removeClass('hidden');
    });
    
    // Modal close handlers
    $('#closeRecipeModal').on('click', () => $('#recipeModal').addClass('hidden'));
    
    $(document).on('click', function(e) {
        if ($(e.target).closest('.bg-white').length === 0 && $('#recipeModal').is(':visible')) {
            $('#recipeModal').addClass('hidden');
        }
    });

    // Window resize handler
    window.addEventListener('resize', () => {
        if (window.currentMealPlan) {
            if (window.innerWidth < 768) {
                renderMobileMealPlan(window.currentMealPlan);
            } else {
                renderDesktopMealPlan(window.currentMealPlan);
            }
        }
    });

    

    // Premium feature handlers
    {% if not has_subscription %}
    $('#downloadMealPlan, #downloadIngredients').on('click', function(e) {
        e.preventDefault();
        if (confirm('This feature requires a premium subscription. Would you like to upgrade now?')) {
            window.location.href = "{% url 'pricing' %}";
        }
    });
    {% endif %}
});
</script>

<script>
    function enforceSubscriptionRestrictions() {
    const subscriptionType = document.getElementById('mealPlanForm').dataset.subscriptionType;
    const planDaysInput = document.getElementById('plan_days');
    const mealsPerDaySelect = document.getElementById('meals_per_day');
    const includeSnacksCheckbox = document.getElementById('include_snacks');

    switch(subscriptionType) {
        case 'free':
            planDaysInput.value = '3';
            planDaysInput.max = '3';
            planDaysInput.readOnly = true;
            mealsPerDaySelect.value = '2';
            mealsPerDaySelect.disabled = true;
            if (includeSnacksCheckbox) {
                includeSnacksCheckbox.checked = false;
                includeSnacksCheckbox.disabled = true;
            }
            break;

        case 'pay_once':
            planDaysInput.max = '7';
            planDaysInput.min = '1';
            planDaysInput.readOnly = false;
            mealsPerDaySelect.disabled = false;
            if (includeSnacksCheckbox) {
                includeSnacksCheckbox.disabled = false;
            }
            break;

        case 'weekly':
            planDaysInput.max = '14';
            planDaysInput.min = '1';
            planDaysInput.readOnly = false;
            mealsPerDaySelect.disabled = false;
            if (includeSnacksCheckbox) {
                includeSnacksCheckbox.disabled = false;
            }
            break;
    }
}
    document.addEventListener('DOMContentLoaded', function() {
        enforceSubscriptionRestrictions();

        // Add form validation
    const mealPlanForm = document.getElementById('mealPlanForm');
    if (mealPlanForm) {
        mealPlanForm.addEventListener('submit', validateSubscriptionForm);
    }

    // Handle meals per day and snacks changes
    const mealsPerDaySelect = document.getElementById('meals_per_day');
    const includeSnacksCheckbox = document.getElementById('include_snacks');

    if (mealsPerDaySelect) {
        mealsPerDaySelect.addEventListener('change', function() {
            if (window.currentMealPlan) {
                if (window.innerWidth < 768) {
                    renderMobileMealPlan(window.currentMealPlan);
                } else {
                    renderDesktopMealPlan(window.currentMealPlan);
                }
            }
        });
    }

    if (includeSnacksCheckbox) {
        includeSnacksCheckbox.addEventListener('change', function() {
            if (window.currentMealPlan) {
                if (window.innerWidth < 768) {
                    renderMobileMealPlan(window.currentMealPlan);
                } else {
                    renderDesktopMealPlan(window.currentMealPlan);
                }
            }
        });
    }
        // Dietary preferences description handling
        const dietarySelect = document.getElementById('dietary_preferences');
        const preferenceDescription = document.getElementById('preference-description');
        
        // Set initial description text
        preferenceDescription.textContent = "Select a dietary style to see its description";

        dietarySelect.addEventListener('change', function() {
        const selected = this.options[this.selectedIndex];
        if (selected.value === "") {
            preferenceDescription.textContent = "Select a dietary style to see its description";
        } else {
            const description = selected.getAttribute('data-description');
            preferenceDescription.textContent = description || "No description available";
        }
    
        // Update the cuisine type based on the selection
        const cuisineSelect = document.getElementById('preferred_cuisine');
        const selectedStyle = selected.value;
        
        // Map the style to the appropriate cuisine
        const cuisineMapping = {
            'yoruba_traditional': 'Yoruba',
            'igbo_traditional': 'Igbo',
            'hausa_traditional': 'Hausa',
            'contemporary_nigerian': 'Contemporary'
        };
        
        if (cuisineMapping[selectedStyle]) {
            cuisineSelect.value = cuisineMapping[selectedStyle];
        }
    });
    
        // Currency handling
        const currencySelect = document.getElementById('currency');
        const currencySymbolSpan = document.getElementById('currency-symbol');
        const budgetInput = document.getElementById('budget');
        
        // Currency symbols mapping
        // const symbols = JSON.parse('{{ supported_currencies|escapejs }}');
        const SUPPORTED_CURRENCIES = {{ supported_currencies|to_json|safe }};
// Update currency symbol when currency selection changes
currencySelect.addEventListener('change', function() {
        const selectedCurrency = this.value;
        // Get the supported currencies from the server-side template
        const currencies = JSON.parse('{{ supported_currencies|escapejs }}');
        currencySymbolSpan.textContent = currencies[selectedCurrency] || '$';
    });
    
        // Exchange rate API endpoint
        async function getExchangeRate(from, to) {
            try {
                const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${from}`);
                const data = await response.json();
                return data.rates[to];
            } catch (error) {
                console.error('Error fetching exchange rate:', error);
                return null;
            }
        }
    
        // Update budget value when currency changes
        currencySelect.addEventListener('change', async function() {
            const oldCurrency = this.dataset.previousCurrency || 'USD';
            const newCurrency = this.value;
            const currentValue = parseFloat(budgetInput.value);
    
            if (currentValue && oldCurrency !== newCurrency) {
                const rate = await getExchangeRate(oldCurrency, newCurrency);
                if (rate) {
                    budgetInput.value = (currentValue * rate).toFixed(2);
                }
            }
    
            this.dataset.previousCurrency = newCurrency;
        });
    });


    document.addEventListener('DOMContentLoaded', function () {
    const dropdownButton = document.getElementById('allergiesDropdownButton');
    const dropdownMenu = document.getElementById('allergiesDropdown');
    const selectedAllergies = document.getElementById('selectedAllergies');
    const checkboxes = dropdownMenu.querySelectorAll('input[type="checkbox"]');

    // Toggle dropdown visibility
    dropdownButton.addEventListener('click', function () {
        dropdownMenu.classList.toggle('hidden');
    });

    // Update selected allergies text
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            const selected = Array.from(checkboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.nextElementSibling.textContent.trim());
            selectedAllergies.textContent = selected.length > 0 ? selected.join(', ') : 'Select allergies';
        });
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function (event) {
        if (!dropdownButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
            dropdownMenu.classList.add('hidden');
        }
    });
});
    </script>
{% endblock %}